<html lang="en" class=" js flexbox canvas canvastext webgl no-touch geolocation postmessage no-websqldatabase indexeddb hashchange history draganddrop websockets rgba hsla multiplebgs backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations csscolumns cssgradients cssreflections csstransforms csstransforms3d csstransitions fontface generatedcontent video audio localstorage sessionstorage webworkers no-applicationcache svg inlinesvg smil svgclippaths"><head>
	<meta charset="utf-8">
	<title>Curriculum Schema Preview</title>
	<link rel="icon" type="image/x-icon" href="/favicon.ico">
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
	<link rel="stylesheet" href="css/print-popup.css">
	<link rel="stylesheet" href="css/ckeditor.richtext.css">
	<link rel="stylesheet" href="css/curriculum.css">
</head>
<body class="curriculog-preview">
	<script src="/js/build/libs.js"></script>
	<script type="text/javascript" src="/js/libs/tracking.js"></script>
	<script src="/js/build/objects.js"></script>
	<script src="/js/build/mvc.js"></script>
	<script>
		var parentProposal = {
			id: window.opener.$('#proposalId').val(),
			status: window.opener.$('#status').val(),
			name: window.opener.$('#curriculog-fields-column-process-name').text()
		}

		function resetCurriculum(active) {
			// var userPermissions = {
			// 	canEdit: 0,
			// 	canImport: 0,
			// 	edits: false
			// };

			// var curricula = new Curriculog.ProposalForm.Curriculum.Curricula({}, {userPermissions: userPermissions, proposal: {id: parentProposal.id}});
			// var preview = new Curriculog.ProposalForm.Curriculum.Preview({collection: curricula});
			var options = {
				proposalID: window.opener.$('#proposalId').val(),
				richText: window.opener.app.cv.options.richText,
				displayPreviewStatus: window.opener.$('#displayCurriculumStatus').val() == 1
			}

			if (active !== undefined) {
				options.active = false;
				options.edits = false;
			}

			cm = new Curriculog.Curricula(options);
			cmView = new Curriculog.CurriculumPreview({collection: cm})
			$('#curriculog-main').html(cmView.el);
		}

		function getPreviewMarkup() {
			$.ajax({
				type: 'POST',
				url: '/gearman-job.json',
				contentType: 'application/json',
				mask: $('body'),
				data: JSON.stringify({
					functionName: 'get_curriculum_tracking_preview_task',
					workload: {
						'module_name': 'ProposalTracking',
						'method_name': 'get_curriculum_tracking_preview_task',
						'method_args': {
							'proposal_id': window.opener.$('#proposalId').val(),
							'active': 'false',
							'edits': 'false',
							'for_preview': 'true',
						}
					}
				}),
				beforeSend: function () {
					objDom.addMask(this.mask, 'Loading preview with markup');
				},

				success: function (results) {
					getBackgroundJobStatus(results.jobHandle, this.mask, 'Show preview with markup', function (jobResults) {
						var options = {
							proposalID: window.opener.$('#proposalId').val(),
							richText: window.opener.app.cv.options.richText,
							displayPreviewStatus: window.opener.$('#displayCurriculumStatus').val() == 1,
							active: false,
							edits: false
						};

						// ensure options are set in collection
						var bgCollection = $.extend(jobResults.result, options);
						try {
							var backgroundCm = new Curriculog.Curricula(bgCollection, options);
							var backgroundCmView = new Curriculog.BackgroundCurriculumPreview({
								collection: backgroundCm
							});
							$('#curriculog-main').html(backgroundCmView.el);
							$('.curriculog-preview').addClass('diff');
						} catch (e) {
							console.error(e);
							objDom.removeMask(this.mask);
							return;
						}

					},
					function(jobResults){
						var taskName = 'show preview with markup';
						$('#growls').notify("create","warning-template", {
							title: 'Warning',
							text: 'An error occurred while attempting to ' + taskName + '. Please try again or contact a system administrator.',
						}, {
							expires: false,
						});
					});
				},

				error: function () {
					objDom.removeMask(this.mask);
				},
			});
		}

		$(document).ready(function() {

			$('#program-name').text(parentProposal.name);

			resetCurriculum();

			$('.print-preview').on('click', function() {
				window.print();
			});

			$('.show-schema').on('click', function() {
				resetCurriculum();
				$('.curriculog-preview').removeClass('diff');
			});

			$('.show-markup').on('click', function() {
				//$('body').mask('Loading preview with markup');
				//resetCurriculum(false);
				getPreviewMarkup();
			});

			if (parentProposal.status == 'unlaunched' || window.opener.$('#curriculumUserTracking').val() == 0) {
				document.getElementById('markup').style.display = "none";
				document.getElementById('preview').style.display = "none";
			}

		});

	</script>

	<div id="preview-tools">
		<button type="button" class="print-preview btn btn-preview-tools" title="Print Curriculum Preview">
			<img src="/images/icons/flat/print.png">
		</button>
		<button id="preview" type="button" class="show-schema btn btn-preview-tools" title="Show Curriculum Preview">
			<img src="/images/icons/flat/edit.png">
		</button>
		<button id="markup" type="button" class="show-markup btn btn-preview-tools" title="Show Curriculum Preview with Markup">
			<img src="/images/icons/flat/markup.png">
		</button>
	</div>
	<h2 id="program-name">
                                                University Honors - University Honors - Chancellor's Honors Program
                    </h2>
	<div id="curriculog-main"><div class="curriculog-preview field-placeholder">
    <div id="schema">
    	<ol>
    	    	</ol>
    </div>
</div></div>


<div id="qtip-rcontainer"></div></body></html>